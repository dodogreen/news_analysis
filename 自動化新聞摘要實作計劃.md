 自動化金融新聞情報系統 — Docker 容器化實作計畫

 Context

 根據 自動化新聞摘要 SPEC 調整.md 規格書，實作一套完整的金融新聞情報系統。用戶要求使用 Docker
 容器化環境，避免污染本地 macOS 環境。排程方式為 host macOS launchd 觸發 docker compose
 run，容器跑完即退出。

 檔案結構

 news_analysis/
 ├── Dockerfile
 ├── docker-compose.yml
 ├── requirements.txt
 ├── .env.example              # 機密資訊範本（API key、SMTP 密碼）
 ├── .gitignore
 ├── config.yaml               # 使用者可編輯設定檔（關鍵字、來源、收件人、參數）
 ├── src/
 │   ├── __init__.py
 │   ├── main.py               # 流程控制器
 │   ├── config.py              # 讀取 config.yaml + 環境變數，提供統一設定介面
 │   ├── models.py              # Article / FilteredArticle dataclass
 │   ├── filter.py              # 關鍵字加權過濾
 │   ├── summarizer.py          # Gemini 1.5 Flash 摘要
 │   ├── email_sender.py        # SMTP + Jinja2 渲染
 │   └── fetchers/
 │       ├── __init__.py
 │       ├── rss_fetcher.py     # feedparser RSS 解析
 │       ├── web_scraper.py     # BeautifulSoup 網頁爬蟲
 │       └── newsapi_fetcher.py # NewsAPI.org REST API
 ├── templates/
 │   └── digest.html            # Jinja2 HTML 郵件範本（全內聯 CSS）
 └── launchd/
     └── com.news.summary.plist # macOS launchd 排程範例

 設定檔設計：config.yaml

 使用者可直接編輯此檔案來自訂系統行為，不需改動任何 Python 程式碼。
 Docker 透過 volume mount 掛載此檔（docker-compose.yml 中設定 ./config.yaml:/app/config.yaml:ro）。

 # 關鍵字與權重（分數越高越優先送入 AI 摘要）
 keywords:
   台積電: 10
   TSMC: 10
   製程: 7
   3nm: 8
   2nm: 8
   營收: 6
   降息: 7
   Fed: 7
   關稅: 8
   AI 伺服器: 9
   NVIDIA: 8
   半導體: 7
   CoWoS: 9
   HBM: 8

 # 過濾門檻：低於此分數的文章不送入 AI
 min_score: 5

 # 送入 Gemini 的文章上限
 max_articles: 50

 # Gemini 模型名稱
 gemini_model: "gemini-1.5-flash"

 # RSS 來源
 rss_feeds:
   MoneyDJ: "https://www.moneydj.com/KMDJ/RSS/RSSFeed.aspx"
   TechNews: "https://technews.tw/feed/"
   BBC_Business: "http://feeds.bbci.co.uk/news/business/rss.xml"
   BBC_Tech: "http://feeds.bbci.co.uk/news/technology/rss.xml"

 # 網頁爬蟲目標
 scrape_targets:
   - name: "鉅亨網"
     url: "https://news.cnyes.com/news/cat/tw_stock"
     api_url: "https://api.cnyes.com/media/api/v1/newslist/category/tw_stock"
     use_api: true
   - name: "工商時報"
     url: "https://www.ctee.com.tw/livenews/lf"
     title_selector: ".title a"
     link_selector: ".title a"

 # NewsAPI 設定
 newsapi:
   enabled: true
   query: "TSMC OR semiconductor OR AI server OR Fed rate"
   language: "en"
   sort_by: "publishedAt"

 # 郵件收件人
 email:
   recipients:
     - user1@example.com
     - user2@example.com
   subject_prefix: "[金融情報]"

 # 摘要分類
 categories:
   - "半導體與伺服器供應鏈"
   - "台股大盤與上市櫃公司動態"
   - "國際宏觀經濟（FED、通膨、關稅政策）"

 設計原則：
 - 機密資訊（API key、SMTP 密碼）放 .env，不進 config.yaml
 - 業務邏輯設定（關鍵字、來源、收件人）放 config.yaml，方便用戶修改
 - src/config.py 負責合併兩者，對其他模組提供統一的設定存取介面

 關鍵設計決策

 1. Docker: python:3.11-slim 基底映像，安裝 gcc/libxml2-dev/libxslt1-dev 供 lxml 編譯
 2. SDK: 使用 google-genai>=1.0.0（新版），呼叫方式為 genai.Client().models.generate_content()
 3. Prompt 策略: 新聞資料放前面，指令放末端（Gemini 注意力最集中處），單次批次處理所有文章
 4. Reuters RSS 已停用: 改用 NewsAPI 索引 Reuters 內容 + BBC RSS 作為國際來源
 5. 鉅亨網 (Anue): 優先使用其公開 API (api.cnyes.com) 取 JSON，避免 JS 動態渲染問題
 6. 容器為 one-shot 模式: 無 restart 策略，由 docker compose run --rm 執行

 實作步驟

 Step 1: 基礎建設

 建立 Dockerfile、docker-compose.yml、requirements.txt、.env.example、.gitignore

 Step 2: 設定檔與資料模型

 建立 config.yaml（使用者可編輯）、src/config.py（讀取 YAML + env vars）、src/models.py（Article
 dataclass）

 Step 3: 資料擷取模組

 - src/fetchers/rss_fetcher.py — feedparser 解析 MoneyDJ、TechNews、BBC RSS
 - src/fetchers/web_scraper.py — BeautifulSoup 爬取鉅亨網、工商時報
 - src/fetchers/newsapi_fetcher.py — NewsAPI REST API 取國際新聞

 Step 4: 過濾模組

 src/filter.py — 關鍵字加權布林搜尋、URL 去重、按分數排序

 Step 5: AI 摘要模組

 src/summarizer.py — Gemini 1.5 Flash 整合，建構 prompt，解析回應

 Step 6: 郵件模組

 - templates/digest.html — 響應式 HTML 範本（內聯 CSS、紅/黃/綠重要度標示）
 - src/email_sender.py — Jinja2 渲染 + SMTP/TLS 發送

 Step 7: 主流程

 src/main.py — 串接所有模組：擷取 → 過濾 → 摘要 → 寄信，含錯誤處理與 logging

 Step 8: 排程設定

 launchd/com.news.summary.plist — 每日 08:30 / 18:00 執行 docker compose run

 容錯設計

 ┌──────────────────┬───────────────────────────────┐
 │       場景       │           處理方式            │
 ├──────────────────┼───────────────────────────────┤
 │ 某新聞源掛掉     │ log warning，繼續處理其他來源 │
 ├──────────────────┼───────────────────────────────┤
 │ 沒有文章通過過濾 │ 寄送「今日無重大新聞」通知信  │
 ├──────────────────┼───────────────────────────────┤
 │ Gemini API 錯誤  │ 寄送僅含原始連結的郵件        │
 ├──────────────────┼───────────────────────────────┤
 │ SMTP 認證失敗    │ log error，以非零退出碼結束   │
 └──────────────────┴───────────────────────────────┘

 驗證方式

 1. docker compose build 確認映像建置成功
 2. docker compose run --rm news-digest 執行完整流程
 3. 確認信件送達，在 Gmail web/mobile 確認 HTML 排版正確
 4. 可用 docker compose run --rm news-digest python -c "from src.fetchers import rss_fetcher; ..."
 單獨測試各模組